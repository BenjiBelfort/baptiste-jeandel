---
import FunkyButton from "./FunkyButton.astro";

const path = Astro.url.pathname.replace(/\/+$/, '') || '/';
function isActive(href: string) {
  const clean = href.replace(/\/+$/, '') || '/';
  return path === clean || (clean !== '/' && path.startsWith(clean + '/'));
}

const services = [
  { href: '/services/eveil-musical', label: 'Éveil musical' },
  { href: '/services/musico-therapie', label: 'Musicothérapie' },
  { href: '/services/spectacles', label: 'Spectacle enfants' },
  { href: '/services/relaxations-sonores', label: 'Relaxations Sonores' },
  { href: '/services/concert-handpan', label: 'Concert Handpan' },
  { href: '/services/archives-sonores', label: 'Archives Sonores' },
];

const formations = [
  { href: '/formations/atelier-ehpad', label: 'Formation EHPAD' },
  { href: '/formations/atelier-petite-enfance', label: 'Formation petite enfance' },
  { href: '/formations/formation-handpan', label: 'Formation Handpan' },
];

const cours = [
  { href: '/cours/handpan', label: 'Cours de Handpan' },
  { href: '/cours/batterie', label: 'Cours de batterie' },
];

const socials = [
  { href: 'https://www.youtube.com/@baptistejeandel', label: 'YouTube', key: 'yt' },
  { href: 'https://www.facebook.com/profile.php?id=100076213966457', label: 'Facebook', key: 'fb' },
  { href: 'https://www.instagram.com/baptiste_jeandel_pro?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==', label: 'Instagram', key: 'ig' },
  { key: 'li', href: 'https://www.linkedin.com/in/baptiste-jeandel-musicien-musicotherapeute/', label: 'LinkedIn' },
];
---
<!-- Skip link -->
<a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[80] focus:px-3 focus:py-2 focus:rounded-lg focus:bg-black focus:text-white">
  Aller au contenu
</a>

<!-- Navbar (au-dessus du menu mobile) -->
<header class="fixed inset-x-0 top-0 z-50 w-full bg-black backdrop-blur text-white">
  <nav class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4 shadow-md">
    <!-- Logo -->
    <a href="/" class="flex items-center gap-4" aria-label="Accueil — Baptiste Jeandel">
      <!-- Logo -->
      <img src="/logos/mini-logo.webp" alt="logo Baptiste Jeandel" class="w-12 h-auto"/>

      <!-- Texte -->
      <span class="font-semibold text-2xl md:text-3xl hand whitespace-nowrap">
        Baptiste Jeandel
      </span>
    </a>

    <!-- Centre : À propos + Services / Formations -->
    <div class="hidden lg:flex items-center gap-8 mx-auto">
      <a href="/#a-propos" class="px-1 py-1 hover:underline underline-offset-6">
        À propos
      </a>

      <!-- Services -->
      <div class="relative group has-menu" data-open="0">
        <a href="/services" class="menu-head inline-flex items-center gap-2 px-1 py-1">
          <svg class="w-3.5 h-3.5 transition-transform duration-150 origin-center group-[data-open='1']:rotate-90 group-hover:rotate-90"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 18l6-6-6-6"></path>
          </svg>
          Services
        </a>

        <div class="absolute left-0 right-0 h-2 top-full"></div>
        <!-- Sous-menu collé à l’entête -->
        <div
          class="absolute left-1/2 top-8 -translate-x-1/2 w-64 text-black bg-redBJ border border-black shadow-lg
                opacity-0 -translate-y-2 pointer-events-none rounded-b-lg
                transition duration-300 ease-in-out
                group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto
                group-[data-open='1']:opacity-100 group-[data-open='1']:translate-y-0 group-[data-open='1']:pointer-events-auto"
          role="menu"
        >
          <ul class="py-2">
            {services.map((s) => (
              <li><a href={s.href} class="block px-6 py-2 hover:font-bold">{s.label}</a></li>
            ))}
            <li class="border-t border-black mt-2">
              <a href="/services" class="block px-6 py-2 font-medium hover:font-bold">Tous les services →</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Formations -->
      <div class="relative group has-menu" data-open="0">
        <a href="/formations" class="menu-head inline-flex items-center gap-2 px-1 py-1">
          <svg class="w-3.5 h-3.5 transition-transform duration-150 origin-center group-[data-open='1']:rotate-90 group-hover:rotate-90"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 18l6-6-6-6"></path>
          </svg>
          Formations
        </a>
        <div class="absolute left-0 right-0 h-2 top-full"></div>
        <div
          class="absolute left-1/2 top-8 -translate-x-1/2 w-64 text-black bg-bleuBJ border border-black shadow-lg
                opacity-0 -translate-y-2 pointer-events-none rounded-b-lg
                transition duration-300 ease-in-out
                group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto
                group-[data-open='1']:opacity-100 group-[data-open='1']:translate-y-0 group-[data-open='1']:pointer-events-auto"
          role="menu"
        >
          <ul class="py-2">
            {formations.map((f) => (
              <li><a href={f.href} class="block px-6 py-2 hover:font-bold">{f.label}</a></li>
            ))}
            <li class="border-t border-black mt-2">
              <a href="/formations" class="block px-6 py-2 font-medium hover:font-bold">Toutes les formations →</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Cours -->
      <div class="relative group has-menu" data-open="0">
        <a href="/cours" class="menu-head inline-flex items-center gap-2 px-1 py-1">
          <svg class="w-3.5 h-3.5 transition-transform duration-150 origin-center group-[data-open='1']:rotate-90 group-hover:rotate-90"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 18l6-6-6-6"></path>
          </svg>
          Cours
        </a>
        <div class="absolute left-0 right-0 h-2 top-full"></div>
        <div
          class="absolute left-1/2 top-8 -translate-x-1/2 w-64 text-black bg-orangeBJ border border-black shadow-lg
                opacity-0 -translate-y-2 pointer-events-none rounded-b-lg
                transition duration-300 ease-in-out
                group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto
                group-[data-open='1']:opacity-100 group-[data-open='1']:translate-y-0 group-[data-open='1']:pointer-events-auto"
          role="menu"
        >
          <ul class="py-2">
            {cours.map((f) => (
              <li><a href={f.href} class="block px-6 py-2 hover:font-bold">{f.label}</a></li>
            ))}
            <li class="border-t border-black mt-2">
              <a href="/cours" class="block px-6 py-2 font-medium hover:font-bold">Toutes les cours →</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Droite : Réseaux + Contact -->
    <div class="hidden lg:flex items-center gap-3">
      <a href="/#reseaux" class="px-1 py-1 hover:underline underline-offset-6">
        Mes internets
      </a>

      <a href="/contact" class="inline-flex text-sm w-20 py-2 justify-center border hover:bg-stone-200 hover:font-bold hover:text-black rounded-full">
        Contact
      </a>
    </div>  


    <!-- Toggle mobile -->
    <button
      type="button"
      class="ml-auto lg:hidden inline-flex items-center justify-center z-50"
      aria-label="Ouvrir le menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
      id="menu-toggle"
    >
      <svg id="icon-open" viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 6h18M3 12h18M3 18h18"></path>
      </svg>
      <svg id="icon-close" viewBox="0 0 24 24" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M18 6L6 18M6 6l12 12"></path>
      </svg>
    </button>
  </nav>

  <!-- Menu mobile (derrière le header : z-[40] < z-[70]) -->
  <div
    id="mobile-menu"
    class="lg:hidden fixed inset-x-0 top-0 -z-10 translate-y-[-100%] aria-[hidden=false]:translate-y-0 transition-transform duration-300 ease-out"
    aria-hidden="true"
  >
    <div class="pt-[64px] lg:pt-[72px] bg-black shadow">
      <div class="max-w-6xl mx-auto px-4 pb-4">
        <nav class="flex flex-col gap-2 py-3">
          <a href="/#a-propos" class="px-2 py-2 text-base hover:underline underline-offset-4">À propos</a>

          <!-- Services (accordion) -->
          <div class="mt-2">
            <button type="button" class="w-full flex items-center justify-between px-2 py-2 text-base font-medium" data-acc="services" aria-expanded="false">
              <span>Services</span>
              <svg class="acc-icon w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"><path d="M15 18 l-6-6 l6-6"/></svg>
            </button>
            <div class="pl-3 hidden" id="acc-services">
              {services.map(s => (<a href={s.href} class="block py-2 text-base hover:underline underline-offset-4">{s.label}</a>))}
              <a href="/services" class="block py-2 text-base font-medium">Tous les services →</a>
            </div>
          </div>

          <!-- Formations (accordion) -->
          <div class="mt-2">
            <button type="button" class="w-full flex items-center justify-between px-2 py-2 text-base font-medium" data-acc="formations" aria-expanded="false">
              <span>Formations</span>
              <svg class="acc-icon w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"><path d="M15 18 l-6-6 l6-6"/></svg>
            </button>
            <div class="pl-3 hidden" id="acc-formations">
              {formations.map(f => (<a href={f.href} class="block py-2 text-base hover:underline underline-offset-4">{f.label}</a>))}
              <a href="/formations" class="block py-2 text-base font-medium">Toutes les formations →</a>
            </div>
          </div>

          <!-- Cours (accordion) -->
          <div class="mt-2">
            <button type="button" class="w-full flex items-center justify-between px-2 py-2 text-base font-medium" data-acc="cours" aria-expanded="false">
              <span>Cours</span>
              <svg class="acc-icon w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"><path d="M15 18 l-6-6 l6-6"/></svg>
            </button>
            <div class="pl-3 hidden" id="acc-cours">
              {cours.map(c => (<a href={c.href} class="block py-2 text-base hover:underline underline-offset-4">{c.label}</a>))}
              <a href="/cours" class="block py-2 text-base font-medium">Tous les cours →</a>
            </div>
          </div>

          <!-- Réseaux (lien texte, plus d’icônes) -->
          <a href="/#reseaux" class="mt-2 px-2 py-2 text-base hover:underline underline-offset-4">
            Réseaux sociaux
          </a>

          <!-- Contact (rounded-full) -->
          <a href="/contact" class="mt-2 px-2 py-2 border text-base text-center rounded-full">
            Contact
          </a>
        </nav>
      </div>
    </div>
  </div>

</header>

<script is:inline>
  // --- Desktop dropdowns ---
  document.querySelectorAll('.has-menu').forEach((box) => {
    const head = box.querySelector('.menu-head');
    box.addEventListener('mouseenter', () => box.setAttribute('data-open', '1'));
    box.addEventListener('mouseleave', () => box.setAttribute('data-open', '0'));
    head?.addEventListener('click', (ev) => {
      const isOpen = box.getAttribute('data-open') === '1';
      if (!isOpen) {
        ev.preventDefault();
        box.setAttribute('data-open', '1');
      }
    });
  });

  // --- Mobile menu toggle (derrière le header) ---
  const toggle = document.getElementById('menu-toggle');
  const mm = document.getElementById('mobile-menu');
  const openI = document.getElementById('icon-open');
  const closeI = document.getElementById('icon-close');

  function setOpen(open) {
    mm.setAttribute('aria-hidden', open ? 'false' : 'true');
    toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    openI.classList.toggle('hidden', open);
    closeI.classList.toggle('hidden', !open);
    document.documentElement.classList.toggle('overflow-hidden', open);
  }
  toggle?.addEventListener('click', () => {
    const isOpen = mm.getAttribute('aria-hidden') === 'false';
    setOpen(!isOpen);
  });
  mm?.addEventListener('click', (e) => {
    const a = e.target.closest('a');
    if (a) setOpen(false);
  });

  // --- Accordéons mobile : un seul ouvert à la fois ---
  const accButtons = Array.from(document.querySelectorAll('[data-acc]'));
  const panels = {
    services: document.getElementById('acc-services'),
    formations: document.getElementById('acc-formations'),
    cours: document.getElementById('acc-cours'),
  };

  function closeAll(exceptKey = null) {
    accButtons.forEach(btn => {
      const key = btn.getAttribute('data-acc');
      const panel = panels[key];
      const icon = btn.querySelector('.acc-icon');
      const isExcept = key === exceptKey;
      const open = isExcept ? !panel.classList.contains('hidden') : false;

      if (!isExcept || !open) {
        panel.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        icon?.classList.remove('-rotate-90');
      }
    });
  }

  accButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.getAttribute('data-acc');
      const panel = panels[key];
      const icon = btn.querySelector('.acc-icon');
      const willOpen = panel.classList.contains('hidden');

      // ferme tous les autres d’abord
      closeAll(key);

      // toggle celui-ci
      panel.classList.toggle('hidden', !willOpen);
      btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
      icon?.classList.toggle('-rotate-90', willOpen);
    });
  });
</script>

