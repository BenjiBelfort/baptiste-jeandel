---
import Site from '@/layouts/SiteLayout.astro';
import FunkyButton from '@/components/FunkyButton.astro';
---

<Site title="Merci — Message envoyé" description="Votre demande a bien été envoyée.">
  <section class="mx-auto max-w-xl px-4 py-20 text-center">
    <img 
      src="/images/annimation/pigeon-merci.png" 
      alt="Pigeon messager"
      width="205"
      height="199"
      class="w-24 mx-auto mb-6 drop-shadow-xl"
    />

    <p id="merci-line" class="text-xl md:text-2xl font-bold mb-2">
      Merci pour votre demande.
    </p>

    <p class="text-stone-700">
      Votre message a bien été envoyé. Je reviens vers vous rapidement.
    </p>

    <div class="mt-8 mb-12">
      <FunkyButton id="home-link" href="/" label="Retour à l’accueil" color="bg-stone-300" />
    </div>
  </section>

  <script is:inline>
    const m = document.createElement('meta');
    m.name = 'robots';
    m.content = 'noindex, nofollow';
    document.head.appendChild(m);
  </script>

  <script is:inline>
    (function () {
      const params = new URLSearchParams(location.search);
      const getQP = (...keys) => {
        for (const k of keys) {
          const v = params.get(k);
          if (v) return v;
        }
        return null;
      };
      const clean = (s) => String(s || '').trim().replace(/\s+/g, ' ');

      let prenom  = getQP('prenom','Prénom','first','first_name','firstName');
      let nom     = getQP('nom','Nom','last','last_name','lastName');
      let full    = getQP('name','Name','nom_complet','Nom complet');
      let domaine = getQP('domaine','Domaine','domain');

      try {
        const ss = sessionStorage;
        const getSS = (...keys) => {
          for (const k of keys) {
            const v = ss.getItem(k);
            if (v) return v;
          }
          return null;
        };
        if (!prenom)  prenom  = getSS('Prénom','prenom','firstName','reg-prenom','reg-firstname');
        if (!nom)     nom     = getSS('Nom','nom','lastName','reg-nom');
        if (!full)    full    = getSS('Nom complet','fullname','name','reg-nom-complet','Nom');
        if (!domaine) domaine = getSS('Domaine','domaine','reg-domaine','domain');
      } catch (_) {}

      const displayName = clean([prenom, nom].filter(Boolean).join(' ')) || clean(full);
      const line = document.getElementById('merci-line');

      if (line) {
        if (displayName && domaine) {
          line.textContent = `Merci ${displayName} pour votre demande sur ${domaine}.`;
        } else if (displayName) {
          line.textContent = `Merci ${displayName}, pour votre demande.`;
        } else if (domaine) {
          line.textContent = `Merci pour votre demande sur ${domaine}.`;
        } else {
          line.textContent = `Merci pour votre demande.`;
        }
      }

      // --- Nettoyage storage (tout de suite + sur interactions) ---------------
      const clear = () => {
        try {
          sessionStorage.removeItem('Prénom');
          sessionStorage.removeItem('prenom');
          sessionStorage.removeItem('firstName');
          sessionStorage.removeItem('reg-prenom');
          sessionStorage.removeItem('reg-firstname');

          sessionStorage.removeItem('Nom');
          sessionStorage.removeItem('lastName');
          sessionStorage.removeItem('reg-nom');

          sessionStorage.removeItem('Nom complet');
          sessionStorage.removeItem('fullname');
          sessionStorage.removeItem('name');
          sessionStorage.removeItem('reg-nom-complet');

          sessionStorage.removeItem('Domaine');
          sessionStorage.removeItem('domaine');
          sessionStorage.removeItem('reg-domaine');
          sessionStorage.removeItem('domain');
        } catch(_) {}
      };

      clear();

      document.getElementById('home-link')?.addEventListener('click', clear);

      window.addEventListener('pageshow', (e) => { if (e.persisted) clear(); });
    })();
  </script>
</Site>
