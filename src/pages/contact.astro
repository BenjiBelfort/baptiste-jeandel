---
import Site from '@/layouts/SiteLayout.astro';

// Pr√©remplissage c√¥t√© serveur (pas de DOM ici)
const url = new URL(Astro.request.url);
const domainFromQuery = url.searchParams.get('domain') ?? '';
const originFromQuery = url.searchParams.get('origin') ?? '';
---

<Site title="Contact ‚Äî Demander un devis" description="Demandez un devis pour services ou formations.">
  <section class="max-w-3xl mx-auto px-4 py-10">
    <!-- Bouton retour -->
    <div class="mb-6">
      <a id="back-link" href="/" class="text-sm underline">‚Üê Retour</a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Demander un devis</h1>
    <p class="text-gray-600 mb-6">
      Choisissez un domaine pour afficher les questions adapt√©es. Tous les champs marqu√©s * sont requis.
    </p>

    <!-- Formulaire Netlify -->
    <form
      id="contact-form"
      method="POST"
      name="devis"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/merci"
      class="space-y-6"
    >
      <!-- requis par Netlify Forms -->
      <input type="hidden" name="form-name" value="devis" />
      <input type="text" name="bot-field" class="hidden" tabindex="-1" autocomplete="off" />

      <!-- Origine (pour l'email Netlify) ‚Äî renomm√© en originPath pour √©viter les doublons -->
      <input type="hidden" id="originPath" name="originPath" value={originFromQuery} />

      <!-- Domaine (pr√©rempli si query) -->
      <label class="block">
        <span class="text-sm">Domaine *</span>
        <select id="domain" name="domain" required class="mt-1 w-full border rounded-lg p-2">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option>EVEIL MUSICAL</option>
          <option>MUSICO THERAPIE</option>
          <option>Spectacles</option>
          <option>Atelier EHPAD</option>
          <option>Atelier Petite Enfance</option>
          <option>Handpan</option>
        </select>
      </label>

      <!-- Champs sp√©cifiques au domaine (rendus via JS) -->
      <div id="dynamic-fields" class="space-y-4"></div>

      <!-- üîí Registre de champs pour Netlify (assure l‚Äôapparition dans les emails) -->
      <div aria-hidden="true" class="hidden">
        <!-- √âVEIL MUSICAL -->
        <input name="age" />
        <input name="nbParticipants" />
        <input name="lieu" />
        <input name="dateSouhaitee" />
        <!-- MUSICO THERAPIE -->
        <input name="public" />
        <input name="frequence" />
        <input name="lieu" />
        <!-- Spectacles -->
        <input name="typeSpectacle" />
        <input name="duree" />
        <input name="lieu" />
        <input name="dateSouhaitee" />
        <!-- Atelier EHPAD -->
        <input name="service" />
        <input name="nbResidents" />
        <input name="frequence" />
        <!-- Atelier Petite Enfance -->
        <input name="structure" />
        <input name="nbEnfants" />
        <input name="age" />
        <!-- Handpan -->
        <input name="niveau" />
        <input name="objectif" />
        <input name="duree" />
      </div>

      <!-- Coordonn√©es -->
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Nom *</span>
          <input name="name" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
        <label class="block">
          <span class="text-sm">Email *</span>
          <input name="email" type="email" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
      </div>

      <label class="block">
        <span class="text-sm">Message</span>
        <textarea name="message" rows="5" class="mt-1 w-full border rounded-lg p-2"></textarea>
      </label>

      <div class="flex items-center justify-between pt-2">
        <button type="button" id="back-btn" class="px-3 py-2 border rounded-lg">Retour</button>
        <button type="submit" class="px-4 py-2 rounded-lg border bg-gray-900 text-white">Envoyer</button>
      </div>
    </form>
  </section>

  <!-- Script client (inline pour √©viter le hoist inutile) -->
  <script is:inline>
    // Mapping des champs par domaine
    const FIELD_MAP = {
      'EVEIL MUSICAL': [
        { name: 'age', label: "√Çge des enfants", type: 'text', required: true },
        { name: 'nbParticipants', label: "Nombre de participants", type: 'number', required: true },
        { name: 'lieu', label: "Lieu (ville)", type: 'text' },
        { name: 'dateSouhaitee', label: "Date souhait√©e", type: 'date' },
      ],
      'MUSICO THERAPIE': [
        { name: 'public', label: "Public (pathologies, besoins)", type: 'text', required: true },
        { name: 'frequence', label: "Fr√©quence (ponctuel / hebdo)", type: 'text' },
        { name: 'lieu', label: "Lieu (√©tablissement)", type: 'text' },
      ],
      'Spectacles': [
        { name: 'typeSpectacle', label: "Type de spectacle", type: 'text', required: true },
        { name: 'duree', label: "Dur√©e (mn)", type: 'number' },
        { name: 'lieu', label: "Lieu", type: 'text' },
        { name: 'dateSouhaitee', label: "Date souhait√©e", type: 'date' },
      ],
      'Atelier EHPAD': [
        { name: 'service', label: "Service / unit√©", type: 'text' },
        { name: 'nbResidents', label: "Nombre de r√©sidents", type: 'number', required: true },
        { name: 'frequence', label: "Fr√©quence", type: 'text' },
      ],
      'Atelier Petite Enfance': [
        { name: 'structure', label: "Structure (cr√®che, RAM...)", type: 'text' },
        { name: 'nbEnfants', label: "Nombre d‚Äôenfants", type: 'number' },
        { name: 'age', label: "Tranche d‚Äô√¢ge", type: 'text' },
      ],
      'Handpan': [
        { name: 'niveau', label: "Niveau (d√©butant, interm√©diaire‚Ä¶)", type: 'text', required: true },
        { name: 'objectif', label: "Objectif", type: 'text' },
        { name: 'duree', label: "Dur√©e souhait√©e", type: 'text' },
      ],
    };

    const params = new URLSearchParams(location.search);
    const domainFromQuery = params.get('domain');
    const originFromQuery = params.get('origin');

    const domainSelect = document.getElementById('domain');
    const dynamic = document.getElementById('dynamic-fields');
    const originPathInput = document.getElementById('originPath');

    function renderFields(domain) {
      const fields = FIELD_MAP[domain] || [];
      dynamic.innerHTML = fields.map(f => `
        <label class="block">
          <span class="text-sm">${f.label}${f.required ? ' *' : ''}</span>
          <input name="${f.name}" ${f.type ? `type="${f.type}"` : ''} ${f.required ? 'required' : ''} class="mt-1 w-full border rounded-lg p-2" />
        </label>
      `).join('');
    }

    // Pr√©-remplissage
    if (domainFromQuery && [...domainSelect.options].some(o => o.value === domainFromQuery)) {
      domainSelect.value = domainFromQuery;
      renderFields(domainFromQuery);
    }
    if (originFromQuery && originPathInput) {
      originPathInput.value = originFromQuery;
    }

    // Changement manuel du domaine
    domainSelect.addEventListener('change', () => renderFields(domainSelect.value));

    // Boutons retour : priorit√© √† l‚Äôhistorique, sinon √† ?origin, sinon /
    const backBtn = document.getElementById('back-btn');
    const backLink = document.getElementById('back-link');
    const fallbackHref = originFromQuery ? `/${originFromQuery}` : '/';
    function goBack() {
      if (document.referrer && new URL(document.referrer).origin === location.origin) {
        history.back();
      } else {
        location.href = fallbackHref;
      }
    }
    backBtn.addEventListener('click', goBack);
    backLink.addEventListener('click', (e) => { e.preventDefault(); goBack(); });

    // Redirection vers /merci?origin=... au moment de l‚Äôenvoi (Netlify Forms)
    const form = document.getElementById('contact-form');
    if (form) {
      form.addEventListener('submit', () => {
        const current = new URL(form.getAttribute('action') || '/merci', location.origin);
        const originVal = (originPathInput && 'value' in originPathInput ? originPathInput.value : '') || originFromQuery || '';
        if (originVal) current.searchParams.set('origin', originVal);
        form.setAttribute('action', current.pathname + current.search);
      });
    }
  </script>
</Site>
