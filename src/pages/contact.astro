---
import Site from '@/layouts/SiteLayout.astro';
import FunkyButton from '@/components/FunkyButton.astro';

// Domain subforms
import MusicoForm from '@/forms/MusicoForm.astro';
import EveilForm from '@/forms/EveilForm.astro';
import HandpanForm from '@/forms/HandpanForm.astro';

const url = new URL(Astro.request.url);
const originFromQuery = url.searchParams.get('origin') ?? '';
const domainFromQuery = url.searchParams.get('domain') ?? '';
---

<Site title="Contact ‚Äî Demander un devis" description="Demandez un devis pour services ou formations.">
  <section class="max-w-3xl mx-auto px-4 py-10">
    <div class="mb-6">
      <a id="back-link" href="/" class="text-sm underline">‚Üê Retour</a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Contact / Demander un devis</h1>
    <p class="text-stone-600 mb-6">
      Choisissez un domaine pour afficher les questions adapt√©es. Tous les champs marqu√©s * sont requis.
    </p>

    <form
      id="contact-form"
      method="POST"
      name="devis-v2"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/merci"
      class="space-y-6"
      autocomplete="off"
    >
      <!-- Netlify Forms -->
      <input type="hidden" name="form-name" value="devis-v2" />
      <input type="text" name="bot-field" class="hidden" tabindex="-1" autocomplete="off" />

      <!-- Provenance -->
      <input type="hidden" id="Provenance" name="Provenance" value={originFromQuery} />

      <!-- Domaine -->
      <label class="block">
        <span>Domaine *</span>
          <select id="domain" name="Domaine" required class="mt-1 w-full border bg-white p-2">
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            <option>√âveil musical</option>
            <option>Musicoth√©rapie</option>
            <option>Relaxations sonores</option>
            <option>Spectacles</option>
            <option>Atelier EHPAD</option>
            <option>Atelier Petite Enfance</option>
            <option>Handpan</option>
            <option>Me contacter</option>
          </select>
      </label>

      <!-- Bloc sp√©cifique domaine -->
      <div id="domain-blocks" class="space-y-6">
        <MusicoForm />
        <EveilForm />
        <HandpanForm />
        <!-- tu pourras ajouter d'autres sous-formulaires ici -->
      </div>

      <!-- Coordonn√©es (communs) -->
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Pr√©nom Nom *</span>
          <input name="Nom" required class="mt-1 w-full border bg-white p-2" />
        </label>
        <label class="block">
          <span class="text-sm">Email *</span>
          <input name="Email" type="email" required class="mt-1 w-full border bg-white p-2" />
        </label>
      </div>

      <label class="block">
        <span class="text-sm">Message</span>
        <textarea name="Message" rows="5" class="mt-1 w-full border bg-white p-2"></textarea>
      </label>

      <!-- Consentement RGPD -->
      <label class="flex items-start gap-2 text-sm">
        <input type="checkbox" name="Consentement RGPD" value="Oui" required class="mt-1" />
        <span>
          J‚Äôaccepte que mes informations soient utilis√©es par <strong>Baptiste Jeandel</strong> afin d‚Äô√™tre recontact√©.
          <br />
          <span class="text-stone-600">
            Vos donn√©es ne sont jamais revendues. En savoir plus :
            <a href="/mentions-legales" class="underline">Mentions l√©gales</a>.
          </span>
        </span>
      </label>

      <div class="flex items-center justify-between pt-2">
        <FunkyButton id="back-btn" as="button" type="button" label="Retour" color="bg-white" />
        <FunkyButton as="button" type="submit" label="Envoyer" color="bg-green-300" />
      </div>
    </form>
  </section>

  <script is:inline>
// -- Affichage du bon sous-formulaire
const domainSelect = document.getElementById('domain');
const blocks = document.querySelectorAll('[data-domain-form]');

function setBlockActive(block, isActive) {
  // montrer / cacher
  block.classList.toggle('hidden', !isActive);

  // activer seulement les champs visibles (sauf les hidden du registre)
  block.querySelectorAll('input, select, textarea').forEach(el => {
    if (el.type === 'hidden') return;       // on laisse les hidden g√©r√©s au submit
    el.disabled = !isActive;                // <- clef : d√©sactive les champs invisibles
    if (!isActive) {
      if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
      else el.value = '';                   // reset propre quand on masque
    }
  });
}

function showBlock(value) {
  blocks.forEach(b => {
    const isActive = b.getAttribute('data-domain-form') === value;
    setBlockActive(b, isActive);
  });
}

// üîÅ mapping legacy -> libell√© exact du select
const LEGACY_TO_FR = {
  'EVEIL MUSICAL': '√âveil musical',
  'MUSICO THERAPIE': 'Musicoth√©rapie',
  'MUSICO-THERAPIE': 'Musicoth√©rapie',
  'Relaxations sonores': 'Relaxations sonores',
  'Spectacles': 'Spectacles',
  'Atelier EHPAD': 'Atelier EHPAD',
  'Atelier Petite Enfance': 'Atelier Petite Enfance',
  'Handpan': 'Handpan',
  'ME CONTACTER': 'Me contacter',
  'Me contacter uniquement': 'Me contacter',
};
function canonicalize(raw) {
  if (!raw) return '';
  return LEGACY_TO_FR[raw] || LEGACY_TO_FR[raw.toUpperCase()] || raw;
}
function optionExists(select, value) {
  return [...select.options].some(o => o.value === value);
}

// init depuis l‚ÄôURL (puis fallback √† la valeur actuelle du select)
const params = new URLSearchParams(location.search);
const raw = params.get('domain') || '';
const mapped = canonicalize(raw);

if (domainSelect) {
  if (mapped && optionExists(domainSelect, mapped)) {
    domainSelect.value = mapped;   // pr√©-s√©lectionne
    showBlock(mapped);             // active le bon sous-form
  } else {
    showBlock(domainSelect.value);
  }
  domainSelect.addEventListener('change', () => showBlock(domainSelect.value));
}
</script>


</Site>
