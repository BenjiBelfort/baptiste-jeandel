---
import Site from '@/layouts/SiteLayout.astro';

const url = new URL(Astro.request.url);
const domainFromQuery = url.searchParams.get('domain') ?? '';
const originFromQuery = url.searchParams.get('origin') ?? '';
---

<Site title="Contact ‚Äî Demander un devis" description="Demandez un devis pour services ou formations.">
  <section class="max-w-3xl mx-auto px-4 py-10">
    <div class="mb-6">
      <a id="back-link" href="/" class="text-sm underline">‚Üê Retour</a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Contact / Demander un devis</h1>
    <p class="text-stone-600 mb-6">
      Choisissez un domaine pour afficher les questions adapt√©es. Tous les champs marqu√©s * sont requis.
    </p>

    <form
      id="contact-form"
      method="POST"
      name="devis-v2"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/merci"
      class="space-y-6"
      autocomplete="off"
    >
      <!-- requis par Netlify Forms -->
      <input type="hidden" name="form-name" value="devis-v2" />
      <input type="text" name="bot-field" class="hidden" tabindex="-1" autocomplete="off" />

      <!-- Provenance (FR) -->
      <input type="hidden" id="Provenance" name="Provenance" value={originFromQuery} />

      <!-- Domaine (FR) -->
      <label class="block">
        <span class="text-sm">Domaine *</span>
        <select id="domain" name="Domaine" required class="mt-1 w-full border rounded-lg p-2">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option>√âveil musical</option>
          <option>Musicoth√©rapie</option>
          <option>Relaxations sonores</option>
          <option>Spectacles</option>
          <option>Atelier EHPAD</option>
          <option>Atelier Petite Enfance</option>
          <option>Handpan</option>
        </select>
      </label>

      <!-- Champs sp√©cifiques (affich√©s via JS, SANS name) -->
      <div id="dynamic-fields" class="space-y-4"></div>

      <!-- üîí Registre cach√© FR (connu par Netlify) ‚Äî tout est hidden + disabled -->
      <div id="registry" aria-hidden="true" class="hidden">
        <input type="hidden" name="√Çge des enfants" id="reg-age" disabled />
        <input type="hidden" name="Nombre de participants" id="reg-nbParticipants" disabled />
        <input type="hidden" name="Lieu" id="reg-lieu" disabled />
        <input type="hidden" name="Date souhait√©e" id="reg-dateSouhaitee" disabled />

        <input type="hidden" name="Public (pathologies, besoins)" id="reg-public" disabled />
        <input type="hidden" name="Fr√©quence" id="reg-frequence" disabled />

        <input type="hidden" name="Type de spectacle" id="reg-typeSpectacle" disabled />
        <input type="hidden" name="Dur√©e (mn)" id="reg-duree" disabled />

        <input type="hidden" name="Service / unit√©" id="reg-service" disabled />
        <input type="hidden" name="Nombre de r√©sidents" id="reg-nbResidents" disabled />

        <input type="hidden" name="Structure (cr√®che, RAM...)" id="reg-structure" disabled />
        <input type="hidden" name="Nombre d‚Äôenfants" id="reg-nbEnfants" disabled />
        <input type="hidden" name="Tranche d‚Äô√¢ge" id="reg-agePe" disabled />

        <input type="hidden" name="Niveau" id="reg-niveau" disabled />
        <input type="hidden" name="Objectif" id="reg-objectif" disabled />
        <input type="hidden" name="Dur√©e souhait√©e" id="reg-dureeHandpan" disabled />
      </div>

      <!-- Coordonn√©es -->
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Nom *</span>
          <input name="Nom" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
        <label class="block">
          <span class="text-sm">Email *</span>
          <input name="Email" type="email" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
      </div>

      <label class="block">
        <span class="text-sm">Message</span>
        <textarea name="Message" rows="5" class="mt-1 w-full border rounded-lg p-2"></textarea>
      </label>

      <!-- Consentement RGPD -->
      <label class="flex items-start gap-2 text-sm">
        <input
          type="checkbox"
          name="Consentement RGPD"
          value="Oui"
          required
          class="mt-1"
        />
        <span>
          J‚Äôaccepte que mes informations soient utilis√©es par <strong>Baptiste Jeandel</strong> afin d‚Äô√™tre recontact√©.
          <br />
          <span class="text-stone-600">
            Vos donn√©es ne sont jamais revendues. En savoir plus :
            <a href="/mentions-legales" class="underline">Mentions l√©gales</a>.
          </span>
        </span>
      </label>

      <div class="flex items-center justify-between pt-2">
        <button type="button" id="back-btn" class="px-3 py-2 border rounded-lg cursor-pointer">Retour</button>
        <button type="submit" class="px-4 py-2 rounded-lg border bg-stone-800 text-white cursor-pointer">Envoyer</button>
      </div>
    </form>
  </section>

  <script is:inline>
    // Map legacy (param URL) -> libell√© FR du select
    const LEGACY_TO_FR = {
      'EVEIL MUSICAL': '√âveil musical',
      'MUSICO THERAPIE': 'Musicoth√©rapie',
      'Spectacles': 'Spectacles',
      'Relaxations sonores': 'Relaxations sonores',
      'Atelier EHPAD': 'Atelier EHPAD',
      'Atelier Petite Enfance': 'Atelier Petite Enfance',
      'Handpan': 'Handpan',
    };

    // Champs par domaine (cl√© technique -> id du registre + label affich√©)
    const FIELD_MAP = {
      '√âveil musical': [
        { key: 'age', regId: 'reg-age', label: '√Çge des enfants', type: 'text', required: true },
        { key: 'nbParticipants', regId: 'reg-nbParticipants', label: 'Nombre de participants', type: 'number', required: true },
        { key: 'lieu', regId: 'reg-lieu', label: 'Lieu', type: 'text' },
        { key: 'dateSouhaitee', regId: 'reg-dateSouhaitee', label: 'Date souhait√©e', type: 'date' },
      ],
      'Musicoth√©rapie': [
        { key: 'public', regId: 'reg-public', label: 'Public (pathologies, besoins)', type: 'text', required: true },
        { key: 'frequence', regId: 'reg-frequence', label: 'Fr√©quence', type: 'text' },
        { key: 'lieu', regId: 'reg-lieu', label: 'Lieu', type: 'text' },
      ],
      'Spectacles': [
        { key: 'typeSpectacle', regId: 'reg-typeSpectacle', label: 'Type de spectacle', type: 'text', required: true },
        { key: 'duree', regId: 'reg-duree', label: 'Dur√©e (mn)', type: 'number' },
        { key: 'lieu', regId: 'reg-lieu', label: 'Lieu', type: 'text' },
        { key: 'dateSouhaitee', regId: 'reg-dateSouhaitee', label: 'Date souhait√©e', type: 'date' },
      ],
      'Relaxations sonores': [
        { key: 'duree',          regId: 'reg-duree',          label: 'Dur√©e (mn)',                  type: 'number' },
        { key: 'nbParticipants', regId: 'reg-nbParticipants', label: 'Nombre de participants',      type: 'number', required: true },
        { key: 'lieu',           regId: 'reg-lieu',           label: 'Lieu',                        type: 'text' },
        { key: 'dateSouhaitee',  regId: 'reg-dateSouhaitee',  label: 'Date souhait√©e',              type: 'date' },
        { key: 'objectif',       regId: 'reg-objectif',       label: 'Objectif (optionnel)',        type: 'text' },
      ],

      'Atelier EHPAD': [
        { key: 'service', regId: 'reg-service', label: 'Service / unit√©', type: 'text' },
        { key: 'nbResidents', regId: 'reg-nbResidents', label: 'Nombre de r√©sidents', type: 'number', required: true },
        { key: 'frequence', regId: 'reg-frequence', label: 'Fr√©quence', type: 'text' },
      ],
      'Atelier Petite Enfance': [
        { key: 'structure', regId: 'reg-structure', label: 'Structure (cr√®che, RAM...)', type: 'text' },
        { key: 'nbEnfants', regId: 'reg-nbEnfants', label: 'Nombre d‚Äôenfants', type: 'number' },
        { key: 'age', regId: 'reg-agePe', label: 'Tranche d‚Äô√¢ge', type: 'text' },
      ],
      'Handpan': [
        { key: 'niveau', regId: 'reg-niveau', label: 'Niveau', type: 'text', required: true },
        { key: 'objectif', regId: 'reg-objectif', label: 'Objectif', type: 'text' },
        { key: 'duree', regId: 'reg-dureeHandpan', label: 'Dur√©e souhait√©e', type: 'text' },
      ],
    };

    const params = new URLSearchParams(location.search);
    const domainParam = params.get('domain'); // peut √™tre legacy (EVEIL MUSICAL)
    const originParam = params.get('origin');

    const domainSelect = document.getElementById('domain');
    const dynamic = document.getElementById('dynamic-fields');
    const provenanceInput = document.getElementById('Provenance');
    const registry = document.getElementById('registry');

    // Rendu des champs visibles (sans name)
    function renderFields(domainFR) {
      const fields = FIELD_MAP[domainFR] || [];
      dynamic.innerHTML = fields.map(f => `
        <label class="block">
          <span class="text-sm">${f.label}${f.required ? ' *' : ''}</span>
          <input ${f.type ? `type="${f.type}"` : ''} ${f.required ? 'required' : ''} data-key="${f.key}" class="mt-1 w-full border rounded-lg p-2" />
        </label>
      `).join('');
    }

    // Pr√©-remplissage domaine depuis l‚ÄôURL
    const mapped = domainParam ? (LEGACY_TO_FR[domainParam] || domainParam) : '';
    if (mapped && [...domainSelect.options].some(o => o.value === mapped)) {
      domainSelect.value = mapped;
      renderFields(mapped);
    }

    // Provenance
    if (originParam && provenanceInput) {
      provenanceInput.value = originParam;
    }

    // Changement manuel
    domainSelect.addEventListener('change', () => renderFields(domainSelect.value));

    // Retour
    const backBtn = document.getElementById('back-btn');
    const backLink = document.getElementById('back-link');
    const fallbackHref = originParam ? `/${originParam}` : '/';
    function goBack() {
      if (document.referrer && new URL(document.referrer).origin === location.origin) {
        history.back();
      } else {
        location.href = fallbackHref;
      }
    }
    backBtn.addEventListener('click', goBack);
    backLink.addEventListener('click', (e) => { e.preventDefault(); goBack(); });

    // Submit : activer UNIQUEMENT les champs du registre qui ont une valeur
    const form = document.getElementById('contact-form');
    if (form) {
      form.addEventListener('submit', () => {
        // 0) Tout d√©sactiver au d√©part
        registry.querySelectorAll('input[type="hidden"]').forEach(inp => {
          inp.disabled = true;
          inp.value = '';
        });

        // 1) Domaine FR : le select a d√©j√† name="Domaine" ‚Üí OK (pas de registre n√©cessaire)

        // 2) Copier les valeurs visibles -> registre et activer uniquement celles non vides
        const fields = FIELD_MAP[domainSelect.value] || [];
        dynamic.querySelectorAll('input[data-key]').forEach(src => {
          const key = src.getAttribute('data-key');
          const cfg = fields.find(f => f.key === key);
          const reg = cfg ? document.getElementById(cfg.regId) : null;
          const val = (src.value || '').trim();
          if (reg && val) {
            reg.value = val;
            reg.disabled = false; // ‚Üê seulement celles-ci seront envoy√©es
          }
        });

        // 3) Redirection /merci?origin=...
        const current = new URL(form.getAttribute('action') || '/merci', location.origin);
        const originVal = provenanceInput?.value || originParam || '';
        if (originVal) current.searchParams.set('origin', originVal);
        form.setAttribute('action', current.pathname + current.search);
      });
    }
  </script>
</Site>
