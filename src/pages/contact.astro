---
import Site from '@/layouts/SiteLayout.astro';

const url = new URL(Astro.request.url);
const domainFromQuery = url.searchParams.get('domain') ?? '';
const originFromQuery = url.searchParams.get('origin') ?? '';
---

<Site title="Contact — Demander un devis" description="Demandez un devis pour services ou formations.">
  <section class="max-w-3xl mx-auto px-4 py-10">
    <div class="mb-6">
      <a id="back-link" href="/" class="text-sm underline">← Retour</a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Demander un devis</h1>
    <p class="text-gray-600 mb-6">
      Choisissez un domaine pour afficher les questions adaptées. Tous les champs marqués * sont requis.
    </p>

    <form
      id="contact-form"
      method="POST"
      name="devis"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/merci"
      class="space-y-6"
    >
      <!-- requis par Netlify Forms -->
      <input type="hidden" name="form-name" value="devis" />
      <input type="text" name="bot-field" class="hidden" tabindex="-1" autocomplete="off" />

      <!-- Origine (un seul champ, nom lisible) -->
      <input type="hidden" id="originPath" name="originPath" value={originFromQuery} />

      <!-- Domaine -->
      <label class="block">
        <span class="text-sm">Domaine *</span>
        <select id="domain" name="domain" required class="mt-1 w-full border rounded-lg p-2">
          <option value="">— Sélectionner —</option>
          <option>EVEIL MUSICAL</option>
          <option>MUSICO THERAPIE</option>
          <option>Spectacles</option>
          <option>Atelier EHPAD</option>
          <option>Atelier Petite Enfance</option>
          <option>Handpan</option>
        </select>
      </label>

      <!-- Champs spécifiques au domaine (affichés via JS, SANS name) -->
      <div id="dynamic-fields" class="space-y-4"></div>

      <!-- Coordonnées -->
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Nom *</span>
          <input name="name" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
        <label class="block">
          <span class="text-sm">Email *</span>
          <input name="email" type="email" required class="mt-1 w-full border rounded-lg p-2" />
        </label>
      </div>

      <label class="block">
        <span class="text-sm">Message</span>
        <textarea name="message" rows="5" class="mt-1 w-full border rounded-lg p-2"></textarea>
      </label>

      <div class="flex items-center justify-between pt-2">
        <button type="button" id="back-btn" class="px-3 py-2 border rounded-lg">Retour</button>
        <button type="submit" class="px-4 py-2 rounded-lg border bg-gray-900 text-white">Envoyer</button>
      </div>
    </form>
  </section>

  <script is:inline>
    // Mapping des champs par domaine
    const FIELD_MAP = {
      'EVEIL MUSICAL': [
        { key: 'age', label: "Âge des enfants", type: 'text', required: true },
        { key: 'nbParticipants', label: "Nombre de participants", type: 'number', required: true },
        { key: 'lieu', label: "Lieu (ville)", type: 'text' },
        { key: 'dateSouhaitee', label: "Date souhaitée", type: 'date' },
      ],
      'MUSICO THERAPIE': [
        { key: 'public', label: "Public (pathologies, besoins)", type: 'text', required: true },
        { key: 'frequence', label: "Fréquence (ponctuel / hebdo)", type: 'text' },
        { key: 'lieu', label: "Lieu (établissement)", type: 'text' },
      ],
      'Spectacles': [
        { key: 'typeSpectacle', label: "Type de spectacle", type: 'text', required: true },
        { key: 'duree', label: "Durée (mn)", type: 'number' },
        { key: 'lieu', label: "Lieu", type: 'text' },
        { key: 'dateSouhaitee', label: "Date souhaitée", type: 'date' },
      ],
      'Atelier EHPAD': [
        { key: 'service', label: "Service / unité", type: 'text' },
        { key: 'nbResidents', label: "Nombre de résidents", type: 'number', required: true },
        { key: 'frequence', label: "Fréquence", type: 'text' },
      ],
      'Atelier Petite Enfance': [
        { key: 'structure', label: "Structure (crèche, RAM...)", type: 'text' },
        { key: 'nbEnfants', label: "Nombre d’enfants", type: 'number' },
        { key: 'age', label: "Tranche d’âge", type: 'text' },
      ],
      'Handpan': [
        { key: 'niveau', label: "Niveau (débutant, intermédiaire…)", type: 'text', required: true },
        { key: 'objectif', label: "Objectif", type: 'text' },
        { key: 'duree', label: "Durée souhaitée", type: 'text' },
      ],
    };

    const params = new URLSearchParams(location.search);
    const domainFromQuery = params.get('domain');
    const originFromQuery = params.get('origin');

    const domainSelect = document.getElementById('domain');
    const dynamic = document.getElementById('dynamic-fields');
    const originPathInput = document.getElementById('originPath');

    function renderFields(domain) {
      const fields = FIELD_MAP[domain] || [];
      dynamic.innerHTML = fields.map(f => `
        <label class="block" data-field>
          <span class="text-sm">${f.label}${f.required ? ' *' : ''}</span>
          <input ${f.type ? `type="${f.type}"` : ''} ${f.required ? 'required' : ''} data-key="${f.key}" class="mt-1 w-full border rounded-lg p-2" />
        </label>
      `).join('');
    }

    // Pré-remplissage
    if (domainFromQuery && [...domainSelect.options].some(o => o.value === domainFromQuery)) {
      domainSelect.value = domainFromQuery;
      renderFields(domainFromQuery);
    }
    if (originFromQuery && originPathInput) originPathInput.value = originFromQuery;

    // Changement manuel du domaine
    domainSelect.addEventListener('change', () => renderFields(domainSelect.value));

    // Boutons retour
    const backBtn = document.getElementById('back-btn');
    const backLink = document.getElementById('back-link');
    const fallbackHref = originFromQuery ? `/${originFromQuery}` : '/';
    function goBack() {
      if (document.referrer && new URL(document.referrer).origin === location.origin) {
        history.back();
      } else {
        location.href = fallbackHref;
      }
    }
    backBtn.addEventListener('click', goBack);
    backLink.addEventListener('click', (e) => { e.preventDefault(); goBack(); });

    // Submit : créer UNIQUEMENT les inputs cachés pour les champs remplis
    const form = document.getElementById('contact-form');
    if (form) {
      form.addEventListener('submit', () => {
        // Nettoie d'anciens auto-champs si déjà ajoutés
        form.querySelectorAll('input[data-auto="1"]').forEach(n => n.remove());

        // Pour chaque champ visible, si valeur non vide -> créer un hidden "name=value"
        dynamic.querySelectorAll('input[data-key]').forEach(src => {
          const key = src.getAttribute('data-key');
          const val = (src.value || '').trim();
          if (!key || !val) return;
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = key;
          hidden.value = val;
          hidden.setAttribute('data-auto', '1');
          form.appendChild(hidden);
        });

        // Redirection vers /merci?origin=...
        const current = new URL(form.getAttribute('action') || '/merci', location.origin);
        const originVal = (originPathInput && 'value' in originPathInput ? originPathInput.value : '') || originFromQuery || '';
        if (originVal) current.searchParams.set('origin', originVal);
        form.setAttribute('action', current.pathname + current.search);
      });
    }
  </script>
</Site>
