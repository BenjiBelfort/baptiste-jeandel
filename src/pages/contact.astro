---
import Site from '@/layouts/SiteLayout.astro';
import FunkyButton from '@/components/FunkyButton.astro';
import PigeonEasterEgg from '@/components/PigeonEasterEgg.astro';

// Domain subforms
import MusicoForm from '@/forms/MusicoForm.astro';
import EveilForm from '@/forms/EveilForm.astro';
import RelaxForm from '@/forms/RelaxForm.astro';
import CoursForm from '@/forms/CoursForm.astro';
import SpectacleForm from '@/forms/SpectacleForm.astro';
import AtelierEhpadForm from '@/forms/AtelierEhpadForm.astro';
import AtelierPeForm from '@/forms/AtelierPeForm.astro';

const url = new URL(Astro.request.url);
const originFromQuery = url.searchParams.get('origin') ?? '';
const domainFromQuery = url.searchParams.get('domain') ?? '';
---

<Site title="Contact — Demander un devis" description="Demandez un devis pour services ou formations.">

  <!-- Anti-FOUC pour les champs conditionnels -->
  <style is:inline>
    [data-show-if] { display: none; }
    [data-show-if].__show { display: block; }
  </style>

  <section class="max-w-3xl mx-auto px-4 py-10">
    <div class="mb-6">
      <a id="back-link" href="/" class="text-sm underline">← Retour</a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Contact / Demander un devis</h1>
    <p class="text-stone-600 mb-6">
      Choisissez un domaine pour afficher les questions adaptées. Tous les champs marqués * sont requis.
    </p>

    <!-- === Formulaire VISIBLE (sans Netlify) === -->
    <form
      id="contact-form"
      method="POST"
      action="/merci"
      class="space-y-6"
      autocomplete="off"
    >
      <!-- Provenance -->
      <input type="hidden" id="Provenance" name="Provenance" value={originFromQuery} />

      <!-- Domaine -->
      <label class="block">
        <span>Domaine *</span>
        <select id="domain" name="Domaine" required class="mt-1 w-full border bg-white p-2">
          <option value="">— Sélectionner —</option>
          <option>Éveil musical</option>
          <option>Musicothérapie</option>
          <option>Relaxations sonores</option>
          <option>Spectacles</option>
          <option>Atelier EHPAD</option>
          <option>Atelier petite enfance</option>
          <option>Cours de batterie / Handpan</option>
          <option>Me contacter</option>
        </select>
      </label>

      <!-- Coordonnées (communs) -->
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Prénom Nom *</span>
          <input name="Nom" required class="mt-1 w-full border bg-white p-2" />
        </label>
        <label class="block">
          <span class="text-sm">Email *</span>
          <input name="Email" type="email" required class="mt-1 w-full border bg-white p-2" />
        </label>
      </div>

      <!-- Bloc spécifique domaine -->
      <div id="domain-blocks" class="space-y-6">
        <MusicoForm />
        <EveilForm />
        <CoursForm />
        <RelaxForm />
        <SpectacleForm />
        <AtelierEhpadForm />
        <AtelierPeForm />
        <!-- tu pourras ajouter d'autres sous-formulaires ici -->
      </div>

      <label class="block">
        <span class="text-sm">Message</span>
        <textarea name="Message" rows="5" class="mt-1 w-full border bg-white p-2"></textarea>
      </label>

      <!-- Consentement RGPD -->
      <div class="flex items-start gap-2 text-sm">
        <input 
          type="checkbox" 
          id="consentement" 
          name="Consentement RGPD" 
          value="Oui" 
          required 
          class="mt-1" 
        />
        <label for="consentement" class="cursor-default select-text">
          J’accepte que mes informations soient utilisées par <strong>Baptiste Jeandel</strong> et son équipe afin d’être recontacté.
          <br />
          <span class="text-stone-600">
            Vos données ne sont jamais revendues. En savoir plus :
            <a href="/mentions-legales" class="underline">Mentions légales</a>.
          </span>
        </label>
      </div>

      <div class="flex items-center justify-between pt-2">
        <FunkyButton id="back-btn" as="button" type="button" label="Retour" color="bg-white" />
        <div class="relative">
          <FunkyButton as="button" type="submit" label="Envoyer" color="bg-green-300" />
          <PigeonEasterEgg />
        </div>
      </div>
    </form>

    <!-- === Formulaire FANTÔME Netlify (invisible) === -->
    <form
      id="shadow-netlify"
      name="devis-v2"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/merci"
      method="POST"
      class="hidden"
      aria-hidden="true"
    >
      <input type="hidden" name="form-name" value="devis-v2" />
      <div style="display:none;">
        <label>Ne pas remplir: <input type="text" name="bot-field" tabindex="-1" autocomplete="off" /></label>
      </div>
    </form>
  </section>

  <script is:inline>
    // ---------- Utilitaires ----------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    // ---------- Sous-formulaires par domaine ----------
    const domainSelect = $('#domain');
    const blocks = $$('[data-domain-form]');

    function setBlockActive(block, isActive) {
      block.classList.toggle('hidden', !isActive);
      // (dés)activer uniquement les champs visibles (pas le registre hidden)
      $$('input, select, textarea', block).forEach(el => {
        if (el.type === 'hidden') return; // les hidden sont gérés au submit
        el.disabled = !isActive;
        if (!isActive) {
          if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
          else el.value = '';
          el.removeAttribute('required');
        }
      });
      if (isActive) setupConditions(block);
    }

    function showBlock(value) {
      blocks.forEach(b => setBlockActive(b, b.getAttribute('data-domain-form') === value));
    }

    // ---------- Mapping legacy -> libellé select ----------
    const LEGACY_TO_FR = {
      'EVEIL MUSICAL': 'Éveil musical',
      'MUSICO THERAPIE': 'Musicothérapie',
      'MUSICO-THERAPIE': 'Musicothérapie',
      'Relaxations sonores': 'Relaxations sonores',
      'Spectacles': 'Spectacles',
      'Atelier EHPAD': 'Atelier EHPAD',
      'Atelier petite enfance': 'Atelier petite enfance',
      'ATELIER PETITE ENFANCE': 'Atelier petite enfance',
      'Atelier Petite Enfance': 'Atelier petite enfance',
      'Cours': 'Cours de batterie / Handpan',
      'ME CONTACTER': 'Me contacter',
      'Me contacter uniquement': 'Me contacter',
    };

    function canonicalize(raw) {
      if (!raw) return '';
      return LEGACY_TO_FR[raw] || LEGACY_TO_FR[raw.toUpperCase()] || raw;
    }

    function optionExists(select, value) {
      return [...select.options].some(o => o.value === value);
    }

    // Init domaine depuis l'URL (puis fallback sur valeur actuelle)
    const params  = new URLSearchParams(location.search);
    const mapped  = canonicalize(params.get('domain') || '');

    if (domainSelect) {
      if (mapped && optionExists(domainSelect, mapped)) {
        domainSelect.value = mapped;
        showBlock(mapped);
      } else {
        showBlock(domainSelect.value);
      }
      domainSelect.addEventListener('change', () => showBlock(domainSelect.value));
    }

    // ---------- Champs conditionnels (showIf) ----------
    function setupConditions(container) {
      const wrappers = $$('[data-show-if]', container);
      if (!wrappers.length) return;

      // cacher d'emblée (anti-flash)
      wrappers.forEach(w => w.classList.add('hidden'));

      function toggleWrapper(wrap, show) {
        if (show) {
          wrap.classList.add('__show');
          wrap.classList.remove('hidden');
        } else {
          wrap.classList.remove('__show');
          wrap.classList.add('hidden');
        }
        // accessibilité/validation + reset doux
        $$('input, select, textarea', wrap).forEach(el => {
          const wantsRequired = el.hasAttribute('data-required'); // opt-in
          if (show) {
            el.disabled = false;
            if (wantsRequired) el.setAttribute('required', 'true');
          } else {
            el.disabled = true;
            el.removeAttribute('required');
            if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
            else el.value = '';
          }
        });
      }

      function evaluateOne(wrap) {
        const depKey    = wrap.getAttribute('data-show-if') || '';
        const equals    = wrap.getAttribute('data-show-eq');
        const equalsAny = (wrap.getAttribute('data-show-any') || '')
          .split(',').map(s => s.trim()).filter(Boolean);

        const depCtrl = container.querySelector(`[data-reg-id="${depKey}"]`);
        if (!depCtrl) { toggleWrapper(wrap, true); return; }

        const val = (depCtrl.value || '').trim();
        let show = true;
        if (equals !== null && equals !== undefined) show = (val === equals);
        if (equalsAny.length) show = equalsAny.includes(val);
        toggleWrapper(wrap, show);
      }

      function evaluateAll() { wrappers.forEach(evaluateOne); }

      // écoute des contrôles pilotes
      const pilots = [...new Set(wrappers.map(w => w.getAttribute('data-show-if')).filter(Boolean))];
      pilots.forEach(key => {
        const ctl = container.querySelector(`[data-reg-id="${key}"]`);
        if (ctl && !ctl.__tc_bound) {
          ctl.addEventListener('input',  evaluateAll);
          ctl.addEventListener('change', evaluateAll);
          ctl.__tc_bound = true;
        }
      });

      evaluateAll();
    }

    // ---------- Bouton retour intelligent ----------
    const originParam = new URLSearchParams(location.search).get('origin');
    const backBtn = $('#back-btn');
    const backLink = $('#back-link');
    const fallbackHref = originParam ? `/${originParam}` : '/';

    function goBack() {
      try {
        if (document.referrer && new URL(document.referrer).origin === location.origin) {
          history.back(); return;
        }
      } catch(e){}
      location.href = fallbackHref;
    }
    backBtn?.addEventListener('click', goBack);
    backLink?.addEventListener('click', (e) => { e.preventDefault(); goBack(); });

    // ---------- Submit : construire et envoyer le formulaire fantôme ----------
    const form   = $('#contact-form');
    const shadow = $('#shadow-netlify');

    function groupByDataRegId(nodeList) {
      const map = new Map();
      nodeList.forEach(el => {
        const key = el.getAttribute('data-reg-id');
        if (!key) return;
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(el);
      });
      return map;
    }

    function valueForGroup(els) {
      if (!els || !els.length) return '';
      const sample = els[0];

      // Radios
      if (sample instanceof HTMLInputElement && sample.type === 'radio') {
        const checked = els.find(e => e.checked);
        return checked ? (checked.value || '').trim() : '';
      }
      // Checkboxes
      if (sample instanceof HTMLInputElement && sample.type === 'checkbox') {
        if (els.length > 1) {
          return els.filter(e => e.checked).map(e => (e.value || '').trim()).join(', ');
        }
        return sample.checked ? (sample.value || 'Oui') : '';
      }
      // Select / Text / Textarea
      return (sample.value || '').trim();
    }

    form?.addEventListener('submit', (e) => {
      // Laisser le navigateur vérifier les "required"
      if (!form.checkValidity()) {
        e.preventDefault();
        form.reportValidity();
        return;
      }

      // On prend la main sur l'envoi
      e.preventDefault();

      // 1) Quel sous-form est actif ?
      const active = $$('[data-domain-form]').find(b => !b.classList.contains('hidden'));

      // 2) Construire l'URL d'action du shadow (/merci?origin=...)
      const baseAction = shadow.getAttribute('action') || '/merci';
      const current = new URL(baseAction, location.origin);
      const originVal = originParam || ($('#Provenance')?.value || '');
      if (originVal) current.searchParams.set('origin', originVal);
      shadow.setAttribute('action', `${current.pathname}${current.search}`);

      // 3) Nettoyer le shadow (on garde seulement form-name + bot-field)
      Array.from(shadow.querySelectorAll('input'))
        .filter(i => !['form-name', 'bot-field'].includes(i.name))
        .forEach(i => i.remove());

      // Helper pour ajouter un champ rempli
      function addField(name, value) {
        const val = (value || '').trim();
        if (!name || !val) return;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = val;
        shadow.appendChild(input);
      }

      // 4) Copier les champs COMMUNS non vides
      addField('Provenance', $('#Provenance')?.value);
      addField('Domaine', $('#domain')?.value);
      addField('Nom', form.querySelector('[name="Nom"]')?.value);
      addField('Email', form.querySelector('[name="Email"]')?.value);
      addField('Message', form.querySelector('[name="Message"]')?.value);
      addField('Consentement RGPD', $('#consentement')?.checked ? 'Oui' : '');

      // 5) Copier les champs du SOUS-FORM actif (via "registry" si présent)
      if (active) {
        // a) Lire les valeurs visibles par data-reg-id
        const groups = groupByDataRegId($$('[data-reg-id]', active));

        // b) Pour chaque groupe, retrouver le "registre" (#reg-xxx) pour obtenir le VRAI nom de champ (name ou data-name)
        groups.forEach((els, key) => {
          const val = valueForGroup(els);
          if (!val) return;

          const hiddenReg = active.querySelector(`#${key}`);
          // Nom du champ : priorité à l'attribut name du registre, sinon data-name, sinon fallback clé
          const fieldName =
            hiddenReg?.getAttribute?.('name') ||
            hiddenReg?.dataset?.name ||
            key;

          addField(fieldName, val);
        });
      }

      // 6) Envoyer le formulaire fantôme (Netlify)
      if (shadow.requestSubmit) shadow.requestSubmit();
      else shadow.submit();
    });
  </script>

</Site>
